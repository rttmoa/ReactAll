{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/storageAdapter.server.js","meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/transform.server.js","meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/length-stream.js","meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/pass-stream.js"],"names":["_storageAdapters","FS","StorageAdapter","storeName","options","api","self","fileKeyMaker","arguments","length","Error","Utility","each","split","name","typeName","internal","indexOf","fileKey","beforeWrite","extend","adapter","fileObj","createReadStreamForFileKey","debug","console","log","safeStream","createReadStream","_transform","logEventsForStream","stream","on","error","message","code","createWriteStreamForFileKey","writeStream","createWriteStream","store","save","type","size","fileChanges","extension","safeOn","result","copies","key","updatedAt","storedAt","Date","createdAt","_saveChanges","once","emitted","emit","_removeAsync","callback","remove","call","File","safeCallback","Meteor","wrapAsync","warn","init","bind","Transform","transformWrite","transformRead","require","inherits","EventEmitter","PassThrough","lengthStream","storage","scope","gm","source","height","color","prototype","destinationStream","aliases","contentType","metadata","addPassThrough","ptStream","originalStream","err","lstream","fileSize","pipe","sourceStream","func","pts","passStream","lengthListener","writeFn","data","encoding","cb","push","endFn","module","exports","Stream","util","PassThroughExt","_writeFn","_endFn","passTransform","chunk","apply","_flush"],"mappings":"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","file":"/packages/steedos_cfs-storage-adapter.js","sourcesContent":["/* global FS, _storageAdapters:true, EventEmitter */\n\n// #############################################################################\n//\n// STORAGE ADAPTER\n//\n// #############################################################################\n_storageAdapters = {};\n\nFS.StorageAdapter = function(storeName, options, api) {\n  var self = this, fileKeyMaker;\n  options = options || {};\n\n  // If storeName is the only argument, a string and the SA already found\n  // we will just return that SA\n  if (arguments.length === 1 && storeName === '' + storeName &&\n          typeof _storageAdapters[storeName] !== 'undefined')\n    return _storageAdapters[storeName];\n\n  // Verify that the storage adapter defines all the necessary API methods\n  if (typeof api === 'undefined') {\n    throw new Error('FS.StorageAdapter please define an api');\n  }\n\n  FS.Utility.each('fileKey,remove,typeName,createReadStream,createWriteStream'.split(','), function(name) {\n    if (typeof api[name] === 'undefined') {\n      throw new Error('FS.StorageAdapter please define an api. \"' + name + '\" ' + (api.typeName || ''));\n    }\n  });\n\n  // Create an internal namespace, starting a name with underscore is only\n  // allowed for stores marked with options.internal === true\n  if (options.internal !== true && storeName[0] === '_') {\n    throw new Error('A storage adapter name may not begin with \"_\"');\n  }\n\n  if (storeName.indexOf('.') !== -1) {\n    throw new Error('A storage adapter name may not contain a \".\"');\n  }\n\n  // store reference for easy lookup by storeName\n  if (typeof _storageAdapters[storeName] !== 'undefined') {\n    throw new Error('Storage name already exists: \"' + storeName + '\"');\n  } else {\n    _storageAdapters[storeName] = self;\n  }\n\n  // User can customize the file key generation function\n  if (typeof options.fileKeyMaker === \"function\") {\n    fileKeyMaker = options.fileKeyMaker;\n  } else {\n    fileKeyMaker = api.fileKey;\n  }\n\n  // User can provide a function to adjust the fileObj\n  // before it is written to the store.\n  var beforeWrite = options.beforeWrite;\n\n  // extend self with options and other info\n  FS.Utility.extend(this, options, {\n    name: storeName,\n    typeName: api.typeName\n  });\n\n  // Create a nicer abstracted adapter interface\n  self.adapter = {};\n\n  self.adapter.fileKey = function(fileObj) {\n    return fileKeyMaker(fileObj);\n  };\n\n  // Return readable stream for fileKey\n  self.adapter.createReadStreamForFileKey = function(fileKey, options) {\n    if (FS.debug) console.log('createReadStreamForFileKey ' + storeName);\n    return FS.Utility.safeStream( api.createReadStream(fileKey, options) );\n  };\n\n  // Return readable stream for fileObj\n  self.adapter.createReadStream = function(fileObj, options) {\n    if (FS.debug) console.log('createReadStream ' + storeName);\n    if (self.internal) {\n      // Internal stores take a fileKey\n      return self.adapter.createReadStreamForFileKey(fileObj, options);\n    }\n    return FS.Utility.safeStream( self._transform.createReadStream(fileObj, options) );\n  };\n\n  function logEventsForStream(stream) {\n    if (FS.debug) {\n      stream.on('stored', function() {\n        console.log('-----------STORED STREAM', storeName);\n      });\n\n      stream.on('close', function() {\n        console.log('-----------CLOSE STREAM', storeName);\n      });\n\n      stream.on('end', function() {\n        console.log('-----------END STREAM', storeName);\n      });\n\n      stream.on('finish', function() {\n        console.log('-----------FINISH STREAM', storeName);\n      });\n\n      stream.on('error', function(error) {\n        console.log('-----------ERROR STREAM', storeName, error && (error.message || error.code));\n      });\n    }\n  }\n\n  // Return writeable stream for fileKey\n  self.adapter.createWriteStreamForFileKey = function(fileKey, options) {\n    if (FS.debug) console.log('createWriteStreamForFileKey ' + storeName);\n    var writeStream = FS.Utility.safeStream( api.createWriteStream(fileKey, options) );\n\n    logEventsForStream(writeStream);\n\n    return writeStream;\n  };\n\n  // Return writeable stream for fileObj\n  self.adapter.createWriteStream = function(fileObj, options) {\n    if (FS.debug) console.log('createWriteStream ' + storeName + ', internal: ' + !!self.internal);\n\n    if (self.internal) {\n      // Internal stores take a fileKey\n      return self.adapter.createWriteStreamForFileKey(fileObj, options);\n    }\n\n    // If we haven't set name, type, or size for this version yet,\n    // set it to same values as original version. We don't save\n    // these to the DB right away because they might be changed\n    // in a transformWrite function.\n    if (!fileObj.name({store: storeName})) {\n      fileObj.name(fileObj.name(), {store: storeName, save: false});\n    }\n    if (!fileObj.type({store: storeName})) {\n      fileObj.type(fileObj.type(), {store: storeName, save: false});\n    }\n    if (!fileObj.size({store: storeName})) {\n      fileObj.size(fileObj.size(), {store: storeName, save: false});\n    }\n\n    // Call user function to adjust file metadata for this store.\n    // We support updating name, extension, and/or type based on\n    // info returned in an object. Or `fileObj` could be\n    // altered directly within the beforeWrite function.\n    if (beforeWrite) {\n      var fileChanges = beforeWrite(fileObj);\n      if (typeof fileChanges === \"object\") {\n        if (fileChanges.extension) {\n          fileObj.extension(fileChanges.extension, {store: storeName, save: false});\n        } else if (fileChanges.name) {\n          fileObj.name(fileChanges.name, {store: storeName, save: false});\n        }\n        if (fileChanges.type) {\n          fileObj.type(fileChanges.type, {store: storeName, save: false});\n        }\n      }\n    }\n\n    var writeStream = FS.Utility.safeStream( self._transform.createWriteStream(fileObj, options) );\n\n    logEventsForStream(writeStream);\n\n    // Its really only the storage adapter who knows if the file is uploaded\n    //\n    // We have to use our own event making sure the storage process is completed\n    // this is mainly\n    writeStream.safeOn('stored', function(result) {\n      if (typeof result.fileKey === 'undefined') {\n        throw new Error('SA ' + storeName + ' type ' + api.typeName + ' did not return a fileKey');\n      }\n      if (FS.debug) console.log('SA', storeName, 'stored', result.fileKey);\n      // Set the fileKey\n      fileObj.copies[storeName].key = result.fileKey;\n\n      // Update the size, as provided by the SA, in case it was changed by stream transformation\n      if (typeof result.size === \"number\") {\n        fileObj.copies[storeName].size = result.size;\n      }\n\n      // Set last updated time, either provided by SA or now\n      fileObj.copies[storeName].updatedAt = result.storedAt || new Date();\n\n      // If the file object copy havent got a createdAt then set this\n      if (typeof fileObj.copies[storeName].createdAt === 'undefined') {\n        fileObj.copies[storeName].createdAt = fileObj.copies[storeName].updatedAt;\n      }\n\n      fileObj._saveChanges(storeName);\n\n      // There is code in transform that may have set the original file size, too.\n      fileObj._saveChanges('_original');\n    });\n\n    // Emit events from SA\n    writeStream.once('stored', function(/*result*/) {\n      // XXX Because of the way stores inherit from SA, this will emit on every store.\n      // Maybe need to rewrite the way we inherit from SA?\n      var emitted = self.emit('stored', storeName, fileObj);\n      if (FS.debug && !emitted) {\n        console.log(fileObj.name() + ' was successfully stored in the ' + storeName + ' store. You are seeing this informational message because you enabled debugging and you have not defined any listeners for the \"stored\" event on this store.');\n      }\n    });\n\n    writeStream.on('error', function(error) {\n      // XXX We could wrap and clarify error\n      // XXX Because of the way stores inherit from SA, this will emit on every store.\n      // Maybe need to rewrite the way we inherit from SA?\n      var emitted = self.emit('error', storeName, error, fileObj);\n      if (FS.debug && !emitted) {\n        console.log(error);\n      }\n    });\n\n    return writeStream;\n  };\n\n  //internal\n  self._removeAsync = function(fileKey, callback) {\n    // Remove the file from the store\n    api.remove.call(self, fileKey, callback);\n  };\n\n  /**\n   * @method FS.StorageAdapter.prototype.remove\n   * @public\n   * @param {FS.File} fsFile The FS.File instance to be stored.\n   * @param {Function} [callback] If not provided, will block and return true or false\n   *\n   * Attempts to remove a file from the store. Returns true if removed or not\n   * found, or false if the file couldn't be removed.\n   */\n  self.adapter.remove = function(fileObj, callback) {\n    if (FS.debug) console.log(\"---SA REMOVE\");\n\n    // Get the fileKey\n    var fileKey = (fileObj instanceof FS.File) ? self.adapter.fileKey(fileObj) : fileObj;\n\n    if (callback) {\n      return self._removeAsync(fileKey, FS.Utility.safeCallback(callback));\n    } else {\n      return Meteor.wrapAsync(self._removeAsync)(fileKey);\n    }\n  };\n\n  self.remove = function(fileObj, callback) {\n    // Add deprecation note\n    console.warn('Storage.remove is deprecating, use \"Storage.adapter.remove\"');\n    return self.adapter.remove(fileObj, callback);\n  };\n\n  if (typeof api.init === 'function') {\n    Meteor.wrapAsync(api.init.bind(self))();\n  }\n\n  // This supports optional transformWrite and transformRead\n  self._transform = new FS.Transform({\n    adapter: self.adapter,\n    // Optional transformation functions:\n    transformWrite: options.transformWrite,\n    transformRead: options.transformRead\n  });\n\n};\n\nrequire('util').inherits(FS.StorageAdapter, EventEmitter);\n","/* global FS, gm */\n\nvar PassThrough = require('stream').PassThrough;\nvar lengthStream = require('./length-stream');\n\nFS.Transform = function(options) {\n  var self = this;\n\n  options = options || {};\n\n  if (!(self instanceof FS.Transform))\n    throw new Error('FS.Transform must be called with the \"new\" keyword');\n\n  if (!options.adapter)\n    throw new Error('Transform expects option.adapter to be a storage adapter');\n\n  self.storage = options.adapter;\n\n  // Fetch the transformation functions if any\n  self.transformWrite = options.transformWrite;\n  self.transformRead = options.transformRead;\n};\n\n// Allow packages to add scope\nFS.Transform.scope = {\n// Deprecate gm scope:\n  gm: function(source, height, color) {\n    console.warn('Deprecation notice: `this.gm` is deprecating in favour of the general global `gm` scope');\n    if (typeof gm !== 'function')\n      throw new Error('No graphicsmagick package installed, `gm` not found in scope, eg. `cfs-graphicsmagick`');\n    return gm(source, height, color);\n  }\n// EO Deprecate gm scope\n};\n\n// The transformation stream triggers an \"stored\" event when data is stored into\n// the storage adapter\nFS.Transform.prototype.createWriteStream = function(fileObj) {\n  var self = this;\n\n  // Get the file key\n  var fileKey = self.storage.fileKey(fileObj);\n\n  // Rig write stream\n  var destinationStream = self.storage.createWriteStreamForFileKey(fileKey, {\n    // Not all SA's can set these options and cfs dont depend on setting these\n    // but its nice if other systems are accessing the SA that some of the data\n    // is also available to those\n    aliases: [fileObj.name()],\n    contentType: fileObj.type(),\n    metadata: fileObj.metadata\n  });\n\n  // Pass through transformWrite function if provided\n  if (typeof self.transformWrite === 'function') {\n\n    destinationStream = addPassThrough(destinationStream, function (ptStream, originalStream) {\n      // Rig transform\n      try {\n        self.transformWrite.call(FS.Transform.scope, fileObj, ptStream, originalStream);\n        // XXX: If the transform function returns a buffer should we stream that?\n      } catch(err) {\n        // We emit an error - should we throw an error?\n        console.warn('FS.Transform.createWriteStream transform function failed, Error: ');\n        throw err;\n      }\n    });\n\n  }\n\n  // If original doesn't have size, add another PassThrough to get and set the size.\n  // This will run on size=0, too, which is OK.\n  // NOTE: This must come AFTER the transformWrite code block above. This might seem\n  // confusing, but by coming after it, this will actually be executed BEFORE the user's\n  // transform, which is what we need in order to be sure we get the original file\n  // size and not the transformed file size.\n  if (!fileObj.size()) {\n    destinationStream = addPassThrough(destinationStream, function (ptStream, originalStream) {\n      var lstream = lengthStream(function (fileSize) {\n        fileObj.size(fileSize, {save: false});\n      });\n\n      ptStream.pipe(lstream).pipe(originalStream);\n    });\n  }\n\n  return destinationStream;\n};\n\nFS.Transform.prototype.createReadStream = function(fileObj, options) {\n  var self = this;\n\n  // Get the file key\n  var fileKey = self.storage.fileKey(fileObj);\n\n  // Rig read stream\n  var sourceStream = self.storage.createReadStreamForFileKey(fileKey, options);\n\n  // Pass through transformRead function if provided\n  if (typeof self.transformRead === 'function') {\n\n    sourceStream = addPassThrough(sourceStream, function (ptStream, originalStream) {\n      // Rig transform\n      try {\n        self.transformRead.call(FS.Transform.scope, fileObj, originalStream, ptStream);\n      } catch(err) {\n        //throw new Error(err);\n        // We emit an error - should we throw an error?\n        sourceStream.emit('error', 'FS.Transform.createReadStream transform function failed');\n      }\n    });\n\n  }\n\n  // We dont transform just normal SA interface\n  return sourceStream;\n};\n\n// Utility function to simplify adding layers of passthrough\nfunction addPassThrough(stream, func) {\n  var pts = new PassThrough();\n  // We pass on the special \"stored\" event for those listening\n  stream.on('stored', function(result) {\n    pts.emit('stored', result);\n  });\n  func(pts, stream);\n  return pts;\n}\n","/*\n * @Author: sunhaolin@hotoa.com\n * @Date: 2022-07-05 20:40:56\n * @LastEditors: sunhaolin@hotoa.com\n * @LastEditTime: 2022-07-06 10:06:48\n * @Description: \n */\n'use strict';\n\nvar passStream = require('./pass-stream');\n\nfunction lengthStream(options, lengthListener) {\n  if (arguments.length === 1) {  // options not provided, shift\n    lengthListener = options;\n    options = {};\n  }\n  options = options || {};\n  if (typeof lengthListener !== 'function') throw new Error('lengthStream requires a lengthListener fn');\n  var length = 0;\n  function writeFn(data, encoding, cb) {\n    /*jshint validthis:true */\n    length += data.length;\n    this.push(data);\n    cb();\n  }\n  function endFn(cb) {\n    /*jshint validthis:true */\n    lengthListener(length); // call with resultant length\n    cb();\n  }\n  var stream = passStream(writeFn, endFn, options);\n  return stream;\n}\n\nmodule.exports = lengthStream;","/*\n * @Author: sunhaolin@hotoa.com\n * @Date: 2022-07-06 10:05:56\n * @LastEditors: sunhaolin@hotoa.com\n * @LastEditTime: 2022-07-06 10:06:05\n * @Description: \n */\n'use strict';\n\nvar Stream = require('stream');\nvar util = require('util');\n\nvar Transform = Stream.Transform;\n\nfunction PassThroughExt(writeFn, endFn, options) {\n  if (!(this instanceof PassThroughExt)) {\n    return new PassThroughExt(writeFn, endFn, options);\n  }\n  Transform.call(this, options);\n  this._writeFn = writeFn;\n  this._endFn = endFn;\n}\n\nutil.inherits(PassThroughExt, Transform);\n\nfunction passTransform(chunk, encoding, cb) {\n  /*jshint validthis:true */\n  this.push(chunk);\n  cb();\n}\n\nPassThroughExt.prototype._transform = function _transform(chunk, encoding, cb) {\n  if (this._writeFn) return this._writeFn.apply(this, arguments);\n  return passTransform.apply(this, arguments);\n};\n\nPassThroughExt.prototype._flush = function _flush(cb) {\n  if (this._endFn) return this._endFn.apply(this, arguments);\n  return cb();\n};\n\nfunction passStream(writeFn, endFn, options) {\n  var stream = new PassThroughExt(writeFn, endFn, options);\n  return stream;\n}\n\nmodule.exports = passStream;"]}