{"version":3,"sources":["meteor://💻app/packages/steedos_workflow-chart/routes/chart.coffee","meteor://💻app/routes/chart.coffee"],"names":["FlowversionAPI","traceMaxApproveCount","traceSplitApprovesIndex","isExpandApprove","getAbsoluteUrl","url","rootUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","writeResponse","res","httpCode","body","statusCode","end","sendInvalidURLResponse","sendAuthTokenExpiredResponse","replaceErrorSymbol","str","replace","getStepHandlerName","step","insId","approverNames","e","loginUserId","stepHandlerName","stepId","userIds","step_type","_id","getHandlersManager","getHandlers","map","userId","user","db","users","findOne","fields","name","join","error","getStepLabel","stepName","getStepName","cachedStepNames","instance_id","cachedStepName","generateStepsGraphSyntax","steps","currentStepId","isConvertToString","direction","graphSyntax","nodes","forEach","lines","length","line","toStep","toStepName","push","findPropertyByPK","to_step","getApproveJudgeText","judge","judgeText","locale","TAPi18n","__","getTraceName","traceName","approveHandlerName","getTraceFromApproveCountersWithType","trace","approves","counters","approve","from_approve_id","type","getTraceCountersWithType","traceFromApproveCounters","toApprove","toApproveFromId","toApproveHandlerName","toApproveType","handler_name","fromApprove","counter","counter2","counterContent","ref","from_type","from_approve_handler_name","to_approve_id","to_approve_handler_name","count","to_approve_handler_names","is_total","pushApprovesWithTypeGraphSyntax","currentTraceName","extraHandlerNamesCounter","fromApproveId","results","splitIndex","tempHandlerNames","toApproveId","toApproves","traceCounters","extraCount","isTypeNode","strToHandlerNames","toHandlerNames","typeName","indexOf","splice","_","isEmpty","results1","generateTracesGraphSyntax","traces","lastApproves","lastTrace","previous_trace_ids","currentFromTraceName","fromApproves","fromTrace","fromApproveHandlerName","fromTraceName","toTraceName","lastApprove","sendHtmlResponse","req","allowDirections","error_msg","flowversion","instance","query","ref1","title","include","decodeURIComponent","instances","flow_version","flow","$slice","WorkflowManager","getInstanceFlowVersion","setHeader","JSON","stringify","JsonRoutes","add","next"],"mappings":"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","file":"/packages/steedos_workflow-chart.js","sourcesContent":["FlowversionAPI =\n\n\ttraceMaxApproveCount: 10\n\ttraceSplitApprovesIndex: 5\n\tisExpandApprove: false\n\n\tgetAbsoluteUrl: (url)->\n\t\trootUrl = if __meteor_runtime_config__ then __meteor_runtime_config__.ROOT_URL_PATH_PREFIX else \"\"\n\t\tif rootUrl\n\t\t\turl = rootUrl + url\n\t\treturn url;\n\n\twriteResponse: (res, httpCode, body)->\n\t\tres.statusCode = httpCode;\n\t\tres.end(body);\n\t\t\n\tsendInvalidURLResponse: (res)->\n\t\treturn @writeResponse(res, 404, \"url must has querys as instance_id.\");\n\t\t\n\tsendAuthTokenExpiredResponse: (res)->\n\t\treturn @writeResponse(res, 401, \"the auth_token has expired.\");\n\n\treplaceErrorSymbol: (str)->\n\t\treturn str.replace(/\\\"/g,\"&quot;\").replace(/\\n/g,\"<br/>\")\n\n\tgetStepHandlerName: (step, insId)->\n\t\ttry\n\t\t\tstepHandlerName = \"\"\n\t\t\tif step.step_type == \"condition\"\n\t\t\t\treturn stepHandlerName\n\n\t\t\t# TODO 获取当前用户userId\n\t\t\tloginUserId = '' \n\t\t\tstepId = step._id\n\t\t\tuserIds = getHandlersManager.getHandlers(insId, stepId, loginUserId)\n\t\t\tapproverNames = userIds.map (userId)->\n\t\t\t\tuser = db.users.findOne(userId, { fields: { name: 1 } })\n\t\t\t\tif user\n\t\t\t\t\treturn user.name\n\t\t\t\telse\n\t\t\t\t\treturn \"\"\n\t\t\tstepHandlerName = approverNames.join(\",\")\n\t\t\t\n\t\t\treturn stepHandlerName\n\t\tcatch e\n\t\t\treturn \"\";\n\t\t# switch step.deal_type\n\t\t# \twhen 'specifyUser'\n\t\t# \t\tapproverNames = step.approver_users.map (userId)->\n\t\t# \t\t\tuser = db.users.findOne(userId)\n\t\t# \t\t\tif user\n\t\t# \t\t\t\treturn user.name\n\t\t# \t\t\telse\n\t\t# \t\t\t\treturn \"\"\n\t\t# \t\tstepHandlerName = approverNames.join(\",\")\n\t\t# \twhen 'applicantRole'\n\t\t# \t\tapproverNames = step.approver_roles.map (roleId)->\n\t\t# \t\t\trole = db.flow_roles.findOne(roleId)\n\t\t# \t\t\tif role\n\t\t# \t\t\t\treturn role.name\n\t\t# \t\t\telse\n\t\t# \t\t\t\treturn \"\"\n\t\t# \t\tstepHandlerName = approverNames.join(\",\")\n\t\t# \telse\n\t\t# \t\tstepHandlerName = ''\n\t\t# \t\tbreak\n\t\t# return stepHandlerName\n\n\tgetStepLabel: (stepName, stepHandlerName)->\n\t\t# 返回sstepName与stepHandlerName结合的步骤显示名称\n\t\tif stepName\n\t\t\tstepName = \"<div class='graph-node'>\n\t\t\t\t<div class='step-name'>#{stepName}</div>\n\t\t\t\t<div class='step-handler-name'>#{stepHandlerName}</div>\n\t\t\t</div>\"\n\t\t\t# 把特殊字符清空或替换，以避免mermaidAPI出现异常\n\t\t\tstepName = FlowversionAPI.replaceErrorSymbol(stepName)\n\t\telse\n\t\t\tstepName = \"\"\n\t\treturn stepName\n\n\tgetStepName: (step, cachedStepNames, instance_id)->\n\t\t# 返回step节点名称，优先从缓存cachedStepNames中取，否则调用getStepLabel生成\n\t\tcachedStepName = cachedStepNames[step._id]\n\t\tif cachedStepName\n\t\t\treturn cachedStepName\n\t\tstepHandlerName = FlowversionAPI.getStepHandlerName(step, instance_id)\n\t\tstepName = FlowversionAPI.getStepLabel(step.name, stepHandlerName)\n\t\tcachedStepNames[step._id] = stepName\n\t\treturn stepName\n\n\tgenerateStepsGraphSyntax: (steps, currentStepId, isConvertToString, direction, instance_id)->\n\t\tnodes = [\"graph #{direction}\"]\n\t\tcachedStepNames = {}\n\t\tsteps.forEach (step)->\n\t\t\tlines = step.lines\n\t\t\tif lines?.length\n\t\t\t\tlines.forEach (line)->\n\t\t\t\t\tif step.name\n\t\t\t\t\t\t# 标记条件节点\n\t\t\t\t\t\tif step.step_type == \"condition\"\n\t\t\t\t\t\t\tnodes.push \"\tclass #{step._id} condition;\"\n\t\t\t\t\t\tstepName = FlowversionAPI.getStepName(step, cachedStepNames, instance_id)\n\t\t\t\t\telse\n\t\t\t\t\t\tstepName = \"\"\n\t\t\t\t\ttoStep = steps.findPropertyByPK(\"_id\",line.to_step)\n\t\t\t\t\ttoStepName = FlowversionAPI.getStepName(toStep, cachedStepNames, instance_id)\n\t\t\t\t\tnodes.push \"\t#{step._id}(\\\"#{stepName}\\\")-->#{line.to_step}(\\\"#{toStepName}\\\")\"\n\n\t\tif currentStepId\n\t\t\tnodes.push \"\tclass #{currentStepId} current-step-node;\"\n\t\tif isConvertToString\n\t\t\tgraphSyntax = nodes.join \"\\n\"\n\t\t\treturn graphSyntax\n\t\telse\n\t\t\treturn nodes\n\n\tgetApproveJudgeText: (judge)->\n\t\tlocale = \"zh-CN\"\n\t\tswitch judge\n\t\t\twhen 'approved'\n\t\t\t\t# 已核准\n\t\t\t\tjudgeText = TAPi18n.__('Instance State approved', {}, locale)\n\t\t\twhen 'rejected'\n\t\t\t\t# 已驳回\n\t\t\t\tjudgeText = TAPi18n.__('Instance State rejected', {}, locale)\n\t\t\twhen 'terminated'\n\t\t\t\t# 已取消\n\t\t\t\tjudgeText = TAPi18n.__('Instance State terminated', {}, locale)\n\t\t\twhen 'reassigned'\n\t\t\t\t# 转签核\n\t\t\t\tjudgeText = TAPi18n.__('Instance State reassigned', {}, locale)\n\t\t\twhen 'relocated'\n\t\t\t\t# 重定位\n\t\t\t\tjudgeText = TAPi18n.__('Instance State relocated', {}, locale)\n\t\t\twhen 'retrieved'\n\t\t\t\t# 已取回\n\t\t\t\tjudgeText = TAPi18n.__('Instance State retrieved', {}, locale)\n\t\t\twhen 'returned'\n\t\t\t\t# 已退回\n\t\t\t\tjudgeText = TAPi18n.__('Instance State returned', {}, locale)\n\t\t\twhen 'readed'\n\t\t\t\t# 已阅\n\t\t\t\tjudgeText = TAPi18n.__('Instance State readed', {}, locale)\n\t\t\telse\n\t\t\t\tjudgeText = ''\n\t\t\t\tbreak\n\t\treturn judgeText\n\n\tgetTraceName: (traceName, approveHandlerName)->\n\t\t# 返回trace节点名称\n\t\tif traceName\n\t\t\t# 把特殊字符清空或替换，以避免mermaidAPI出现异常\n\t\t\ttraceName = \"<div class='graph-node'>\n\t\t\t\t<div class='trace-name'>#{traceName}</div>\n\t\t\t\t<div class='trace-handler-name'>#{approveHandlerName}</div>\n\t\t\t</div>\"\n\t\t\ttraceName = FlowversionAPI.replaceErrorSymbol(traceName)\n\t\telse\n\t\t\ttraceName = \"\"\n\t\treturn traceName\n\t\n\tgetTraceFromApproveCountersWithType: (trace)->\n\t\t# 该函数生成json结构，表现出所有传阅、分发、转发节点有有后续子节点的计数情况，其结构为：\n\t\t# counters = {\n\t\t# \t[fromApproveId(来源节点ID)]:{\n\t\t# \t\t[toApproveType(目标结点类型)]:目标节点在指定类型下的后续节点个数\n\t\t# \t}\n\t\t# }\n\t\tcounters = {}\n\t\tapproves = trace.approves\n\t\tunless approves\n\t\t\treturn null\n\t\tapproves.forEach (approve)->\n\t\t\tif approve.from_approve_id\n\t\t\t\tunless counters[approve.from_approve_id]\n\t\t\t\t\tcounters[approve.from_approve_id] = {}\n\t\t\t\tif counters[approve.from_approve_id][approve.type]\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type]++\n\t\t\t\telse\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type] = 1\n\t\treturn counters\n\n\tgetTraceCountersWithType: (trace, traceFromApproveCounters)->\n\t\t# 该函数生成json结构，表现出所有传阅、分发、转发的节点流向，其结构为：\n\t\t# counters = {\n\t\t# \t[fromApproveId(来源节点ID)]:{\n\t\t# \t\t[toApproveType(目标结点类型)]:[{\n\t\t# \t\t\tfrom_type: 来源节点类型\n\t\t# \t\t\tfrom_approve_handler_name: 来源节点处理人\n\t\t# \t\t\tto_approve_id: 目标节点ID\n\t\t# \t\t\tto_approve_handler_names: [多个目标节点汇总处理人集合]\n\t\t# \t\t\tis_total: true/false，是否汇总节点\n\t\t# \t\t},...]\n\t\t# \t}\n\t\t# }\n\t\t# 上述目标结点内容中有一个属性is_total表示是否汇总节点，如果是，则把多个节点汇总合并成一个，\n\t\t# 但是本身有后续子节点的节点不参与汇总及计数。\n\t\tcounters = {}\n\t\tapproves = trace.approves\n\t\tunless approves\n\t\t\treturn null\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\n\t\tisExpandApprove = FlowversionAPI.isExpandApprove\n\n\t\tapproves.forEach (toApprove)->\n\t\t\ttoApproveType = toApprove.type\n\t\t\ttoApproveFromId = toApprove.from_approve_id\n\t\t\ttoApproveHandlerName = toApprove.handler_name\n\t\t\tunless toApproveFromId\n\t\t\t\treturn\n\t\t\tapproves.forEach (fromApprove)->\n\t\t\t\tif fromApprove._id == toApproveFromId\n\t\t\t\t\tcounter = counters[toApproveFromId]\n\t\t\t\t\tunless counter\n\t\t\t\t\t\tcounter = counters[toApproveFromId] = {}\n\t\t\t\t\tunless counter[toApprove.type]\n\t\t\t\t\t\tcounter[toApprove.type] = []\n\t\t\t\t\tcounter2 = counter[toApprove.type]\n\t\t\t\t\tif traceFromApproveCounters[toApprove._id]?[toApproveType]\n\t\t\t\t\t\t# 有后续子节点，则不参与汇总及计数\n\t\t\t\t\t\tcounter2.push\n\t\t\t\t\t\t\tfrom_type: fromApprove.type\n\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\n\t\t\t\t\t\t\tto_approve_id: toApprove._id\n\t\t\t\t\t\t\tto_approve_handler_name: toApprove.handler_name\n\n\t\t\t\t\telse\n\t\t\t\t\t\tcounterContent = if isExpandApprove then null else counter2.findPropertyByPK(\"is_total\", true)\n\t\t\t\t\t\t# counterContent = counter2.findPropertyByPK(\"is_total\", true)\n\t\t\t\t\t\t# 如果强制要求展开所有节点，则不做汇总处理\n\t\t\t\t\t\tif counterContent\n\t\t\t\t\t\t\tcounterContent.count++\n\t\t\t\t\t\t\tunless counterContent.count > traceMaxApproveCount\n\t\t\t\t\t\t\t\tcounterContent.to_approve_handler_names.push toApprove.handler_name\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tcounter2.push\n\t\t\t\t\t\t\t\tfrom_type: fromApprove.type\n\t\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\n\t\t\t\t\t\t\t\tto_approve_id: toApprove._id\n\t\t\t\t\t\t\t\tcount: 1\n\t\t\t\t\t\t\t\tto_approve_handler_names: [toApprove.handler_name]\n\t\t\t\t\t\t\t\tis_total: true\n\n\t\treturn counters\n\n\tpushApprovesWithTypeGraphSyntax: (nodes, trace)->\n\t\ttraceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType trace\n\t\ttraceCounters = FlowversionAPI.getTraceCountersWithType trace, traceFromApproveCounters\n\t\tunless traceCounters\n\t\t\treturn\n\t\textraHandlerNamesCounter = {} #记录需要额外生成所有处理人姓名的被传阅、分发、转发节点\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\n\t\tsplitIndex = FlowversionAPI.traceSplitApprovesIndex\n\t\tcurrentTraceName = trace.name\n\t\tfor fromApproveId,fromApprove of traceCounters\n\t\t\tfor toApproveType,toApproves of fromApprove\n\t\t\t\ttoApproves.forEach (toApprove)->\n\t\t\t\t\ttypeName = \"\"\n\t\t\t\t\tswitch toApproveType\n\t\t\t\t\t\twhen 'cc'\n\t\t\t\t\t\t\ttypeName = \"传阅\"\n\t\t\t\t\t\twhen 'forward'\n\t\t\t\t\t\t\ttypeName = \"转发\"\n\t\t\t\t\t\twhen 'distribute'\n\t\t\t\t\t\t\ttypeName = \"分发\"\n\t\t\t\t\tisTypeNode = [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.from_type) >= 0\n\t\t\t\t\tif isTypeNode\n\t\t\t\t\t\ttraceName = toApprove.from_approve_handler_name\n\t\t\t\t\telse\n\t\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.from_approve_handler_name\n\t\t\t\t\tif toApprove.is_total\n\t\t\t\t\t\ttoHandlerNames = toApprove.to_approve_handler_names\n\t\t\t\t\t\tif splitIndex and toApprove.count > splitIndex\n\t\t\t\t\t\t\t# 在姓名集合中插入回车符号换行\n\t\t\t\t\t\t\ttoHandlerNames.splice(splitIndex,0,\"<br/>,\")\n\t\t\t\t\t\tstrToHandlerNames = toHandlerNames.join(\",\").replace(\",,\",\"\")\n\t\t\t\t\t\textraCount = toApprove.count - traceMaxApproveCount\n\t\t\t\t\t\tif extraCount > 0\n\t\t\t\t\t\t\tstrToHandlerNames += \"等#{toApprove.count}人\"\n\t\t\t\t\t\t\tunless extraHandlerNamesCounter[fromApproveId]\n\t\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId] = {}\n\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id\n\t\t\t\t\telse\n\t\t\t\t\t\tstrToHandlerNames = toApprove.to_approve_handler_name\n\t\t\t\t\tif isTypeNode\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}>\\\"#{traceName}\\\"]--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\n\t\t\t\t\telse\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}(\\\"#{traceName}\\\")--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\n\n\t\t# 为需要额外生成所有处理人姓名的被传阅、分发、转发节点，增加鼠标弹出详细层事件\n\t\t# extraHandlerNamesCounter的结构为：\n\t\t# counters = {\n\t\t# \t[fromApproveId(来源节点ID)]:{\n\t\t# \t\t[toApproveType(目标结点类型)]:目标结点ID\n\t\t# \t}\n\t\t# }\n\t\tapproves = trace.approves\n\t\tunless _.isEmpty(extraHandlerNamesCounter)\n\t\t\tfor fromApproveId,fromApprove of extraHandlerNamesCounter\n\t\t\t\tfor toApproveType,toApproveId of fromApprove\n\t\t\t\t\ttempHandlerNames = []\n\t\t\t\t\tapproves.forEach (approve)->\n\t\t\t\t\t\tif fromApproveId == approve.from_approve_id\n\t\t\t\t\t\t\tunless traceFromApproveCounters[approve._id]?[toApproveType]\n\t\t\t\t\t\t\t\t# 有后续子节点，则不参与汇总及计数\n\t\t\t\t\t\t\t\ttempHandlerNames.push approve.handler_name\n\t\t\t\t\tnodes.push \"\tclick #{toApproveId} callback \\\"#{tempHandlerNames.join(\",\")}\\\"\"\n\n\tgenerateTracesGraphSyntax: (traces, isConvertToString, direction)->\n\t\tnodes = [\"graph #{direction}\"]\n\t\tlastTrace = null\n\t\tlastApproves = []\n\t\ttraces.forEach (trace)->\n\t\t\tlines = trace.previous_trace_ids\n\t\t\tcurrentTraceName = trace.name\n\t\t\tif lines?.length\n\t\t\t\tlines.forEach (line)->\n\t\t\t\t\tfromTrace = traces.findPropertyByPK(\"_id\",line)\n\t\t\t\t\tcurrentFromTraceName = fromTrace.name\n\t\t\t\t\tfromApproves = fromTrace.approves\n\t\t\t\t\ttoApproves = trace.approves\n\t\t\t\t\tlastTrace = trace\n\t\t\t\t\tlastApproves = toApproves\n\t\t\t\t\tfromApproves.forEach (fromApprove)->\n\t\t\t\t\t\tfromApproveHandlerName = fromApprove.handler_name\n\t\t\t\t\t\tif toApproves?.length\n\t\t\t\t\t\t\ttoApproves.forEach (toApprove)->\n\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.type) < 0\n\t\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\n\t\t\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\n\t\t\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.handler_name\n\t\t\t\t\t\t\t\t\t\t# 不是传阅、分发、转发，则连接到下一个trace\n\t\t\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\n\t\t\t\t\t\t\t\t\t\tif judgeText\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t# 最后一个步骤的trace\n\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\n\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\n\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName)\n\t\t\t\t\t\t\t\t# 不是传阅、分发、转发，则连接到下一个trace\n\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\n\t\t\t\t\t\t\t\tif judgeText\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{trace._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{trace._id}(\\\"#{toTraceName}\\\")\"\n\t\t\telse\n\t\t\t\t# 第一个trace，因traces可能只有一个，这时需要单独显示出来\n\t\t\t\ttrace.approves.forEach (approve)->\n\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, approve.handler_name\n\t\t\t\t\tnodes.push \"\t#{approve._id}(\\\"#{traceName}\\\")\"\n\n\t\t\tFlowversionAPI.pushApprovesWithTypeGraphSyntax nodes, trace\n\n\t\t# 签批历程中最后的approves高亮显示，结束步骤的trace中是没有approves的，所以结束步骤不高亮显示\n\t\tlastApproves?.forEach (lastApprove)->\n\t\t\tnodes.push \"\tclass #{lastApprove._id} current-step-node;\"\n\n\t\tif isConvertToString\n\t\t\tgraphSyntax = nodes.join \"\\n\"\n\t\t\treturn graphSyntax\n\t\telse\n\t\t\treturn nodes\n\n\tsendHtmlResponse: (req, res, type)->\n\t\tquery = req.query\n\t\tinstance_id = query.instance_id\n\t\tdirection = query.direction || 'TD'\n\t\tallowDirections = ['TB','BT','RL','LR','TD'];\n\n\t\tif !_.include(allowDirections, direction)\n\t\t\treturn @writeResponse(res, 500, \"Invalid direction. The value of direction should be in ['TB', 'BT', 'RL', 'LR', 'TD']\");\n\n\t\tunless instance_id\n\t\t\tFlowversionAPI.sendInvalidURLResponse res \n\t\t\n\t\ttitle = query.title\n\t\tif title\n\t\t\ttitle = decodeURIComponent(decodeURIComponent(title))\n\t\telse\n\t\t\ttitle = \"Workflow Chart\"\n\n\t\terror_msg = \"\"\n\t\tgraphSyntax = \"\"\n\t\tFlowversionAPI.isExpandApprove = false\n\t\tif type == \"traces_expand\"\n\t\t\ttype = \"traces\"\n\t\t\tFlowversionAPI.isExpandApprove = true\n\t\tswitch type\n\t\t\twhen 'traces'\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{traces: 1}}\n\t\t\t\tif instance\n\t\t\t\t\ttraces = instance.traces\n\t\t\t\t\tif traces?.length\n\t\t\t\t\t\tgraphSyntax = this.generateTracesGraphSyntax traces, false, direction\n\t\t\t\t\telse\n\t\t\t\t\t\terror_msg = \"没有找到当前申请单的流程步骤数据\"\n\t\t\t\telse\n\t\t\t\t\terror_msg = \"当前申请单不存在或已被删除\"\n\t\t\telse\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{flow_version:1,flow:1,traces: {$slice: -1}}}\n\t\t\t\tif instance\n\t\t\t\t\tcurrentStepId = instance.traces?[0]?.step\n\t\t\t\t\tflowversion = WorkflowManager.getInstanceFlowVersion(instance)\n\t\t\t\t\tsteps = flowversion?.steps\n\t\t\t\t\tif steps?.length\n\t\t\t\t\t\tgraphSyntax = this.generateStepsGraphSyntax steps,currentStepId,false, direction, instance_id\n\t\t\t\t\telse\n\t\t\t\t\t\terror_msg = \"没有找到当前申请单的流程步骤数据\"\n\t\t\t\telse\n\t\t\t\t\terror_msg = \"当前申请单不存在或已被删除\"\n\t\t\t\tbreak\n\t\tres.setHeader('Content-Type', 'text/html');\n\t\treturn @writeResponse res, 200, \"\"\"\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t\t<meta charset=\"utf-8\">\n\t\t\t\t\t<meta name=\"viewport\" content=\"width=device-width,initial-scale=1,user-scalable=yes\">\n\t\t\t\t\t<title>#{title}</title>\n\t\t\t\t\t<meta name=\"mobile-web-app-capable\" content=\"yes\">\n\t\t\t\t\t<meta name=\"theme-color\" content=\"#000\">\n\t\t\t\t\t<meta name=\"application-name\">\n\t\t\t\t\t<script type=\"text/javascript\" src=\"/unpkg.com/jquery@1.11.2/dist/jquery.min.js\"></script>\n\t\t\t\t\t<script type=\"text/javascript\" src=\"/unpkg.com/mermaid@9.1.2/dist/mermaid.min.js\"></script>\n\t\t\t\t\t<style>\n\t\t\t\t\t\tbody { \n\t\t\t\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tbackground-color: #fff;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.loading{\n\t\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\t\tleft: 0px;\n\t\t\t\t\t\t\tright: 0px;\n\t\t\t\t\t\t\ttop: 50%;\n\t\t\t\t\t\t\tz-index: 1100;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tmargin-top: -30px;\n\t\t\t\t\t\t\tfont-size: 36px;\n\t\t\t\t\t\t\tcolor: #dfdfdf;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.error-msg{\n\t\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\t\tleft: 0px;\n\t\t\t\t\t\t\tright: 0px;\n\t\t\t\t\t\t\tbottom: 20px;\n\t\t\t\t\t\t\tz-index: 1100;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tfont-size: 20px;\n\t\t\t\t\t\t\tcolor: #a94442;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node rect{\n\t\t\t\t\t\t\tfill: #ccccff;\n\t\t\t\t\t\t\tstroke: rgb(144, 144, 255);\n    \t\t\t\t\t\tstroke-width: 2px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node.current-step-node rect{\n\t\t\t\t\t\t\tfill: #cde498;\n\t\t\t\t\t\t\tstroke: #13540c;\n\t\t\t\t\t\t\tstroke-width: 2px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node.condition rect{\n\t\t\t\t\t\t\tfill: #ececff;\n\t\t\t\t\t\t\tstroke: rgb(204, 204, 255);\n    \t\t\t\t\t\tstroke-width: 1px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node .trace-handler-name{\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node .step-handler-name{\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdiv.mermaidTooltip{\n\t\t\t\t\t\t\tposition: fixed!important;\n\t\t\t\t\t\t\ttext-align: left!important;\n\t\t\t\t\t\t\tpadding: 4px!important;\n\t\t\t\t\t\t\tfont-size: 14px!important;\n\t\t\t\t\t\t\tmax-width: 500px!important;\n\t\t\t\t\t\t\tleft: auto!important;\n\t\t\t\t\t\t\ttop: 15px!important;\n\t\t\t\t\t\t\tright: 15px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom{\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\n\t\t\t\t\t\t\tborder-color: transparent;\n\t\t\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\t\t\tpadding: 2px 10px;\n\t\t\t\t\t\t\tfont-size: 26px;\n\t\t\t\t\t\t\tborder-radius: 20px;\n\t\t\t\t\t\t\tbackground: #eee;\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\t\tbottom: 15px;\n\t\t\t\t\t\t\toutline: none;\n\t\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t\t\tz-index: 99999;\n\t\t\t\t\t\t\t-webkit-user-select: none;\n\t\t\t\t\t\t\t-moz-user-select: none;\n\t\t\t\t\t\t\t-ms-user-select: none;\n\t\t\t\t\t\t\tuser-select: none;\n\t\t\t\t\t\t\tline-height: 1.2;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t@media (max-width: 768px) {\n\t\t\t\t\t\t\t.btn-zoom{\n\t\t\t\t\t\t\t\tdisplay:none;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom:hover{\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom-up{\n\t\t\t\t\t\t\tleft: 15px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom-down{\n\t\t\t\t\t\t\tleft: 60px;\n\t\t\t\t\t\t\tpadding: 1px 13px 3px 13px;\n\t\t\t\t\t\t}\n\t\t\t\t\t</style>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t\t<div class = \"loading\">Loading...</div>\n\t\t\t\t\t<div class = \"error-msg\">#{error_msg}</div>\n\t\t\t\t\t<div class=\"mermaid\"></div>\n\t\t\t\t\t<script type=\"text/javascript\">\n\t\t\t\t\t\tmermaid.initialize({\n\t\t\t\t\t\t\tstartOnLoad:false\n\t\t\t\t\t\t});\n\t\t\t\t\t\t$(function(){\n\t\t\t\t\t\t\tvar graphNodes = #{JSON.stringify(graphSyntax)};\n\t\t\t\t\t\t\t//方便前面可以通过调用mermaid.currentNodes调式，特意增加currentNodes属性。\n\t\t\t\t\t\t\tmermaid.currentNodes = graphNodes;\n\t\t\t\t\t\t\tvar graphSyntax = graphNodes.join(\"\\\\n\");\n\t\t\t\t\t\t\tconsole.log(graphNodes);\n\t\t\t\t\t\t\tconsole.log(graphSyntax);\n\t\t\t\t\t\t\tconsole.log(\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\");\n\t\t\t\t\t\t\t$(\".loading\").remove();\n\n\t\t\t\t\t\t\tvar id = \"flow-steps-svg\";\n\t\t\t\t\t\t\tvar element = $('.mermaid');\n\t\t\t\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\n\t\t\t\t\t\t\t\telement.html(svgCode);\n\t\t\t\t\t\t\t\tif(typeof callback !== 'undefined'){\n\t\t\t\t\t\t\t\t\tcallback(id);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbindFunctions(element[0]);\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\n\n\t\t\t\t\t\t\tvar zoomSVG = function(zoom){\n\t\t\t\t\t\t\t\tvar currentWidth = $(\"svg\").width();\n\t\t\t\t\t\t\t\tvar newWidth = currentWidth * zoom;\n\t\t\t\t\t\t\t\t$(\"svg\").css(\"maxWidth\",newWidth + \"px\").width(newWidth);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//支持鼠标滚轮缩放画布\n\t\t\t\t\t\t\t$(window).on(\"mousewheel\",function(event){\n\t\t\t\t\t\t\t\tif(event.ctrlKey){\n\t\t\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\n\t\t\t\t\t\t\t\t\tzoomSVG(zoom);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t$(\".btn-zoom\").on(\"click\",function(){\n\t\t\t\t\t\t\t\tzoomSVG($(this).attr(\"zoom\"));\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t</script>\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-up\" zoom=1.1 title=\"点击放大\">+</a>\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-down\" zoom=0.9 title=\"点击缩小\">-</a>\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t\"\"\"\n\nJsonRoutes.add 'get', '/api/workflow/chart?instance_id=:instance_id', (req, res, next) ->\n\t# 流程图\n\tFlowversionAPI.sendHtmlResponse req, res\n\nJsonRoutes.add 'get', '/api/workflow/chart/traces?instance_id=:instance_id', (req, res, next) ->\n\t# 汇总签批历程图\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces\"\n\nJsonRoutes.add 'get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', (req, res, next) ->\n\t# 展开所有节点的签批历程图\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces_expand\"\n\n","var FlowversionAPI;\n\nFlowversionAPI = {\n  traceMaxApproveCount: 10,\n  traceSplitApprovesIndex: 5,\n  isExpandApprove: false,\n  getAbsoluteUrl: function(url) {\n    var rootUrl;\n    rootUrl = __meteor_runtime_config__ ? __meteor_runtime_config__.ROOT_URL_PATH_PREFIX : \"\";\n    if (rootUrl) {\n      url = rootUrl + url;\n    }\n    return url;\n  },\n  writeResponse: function(res, httpCode, body) {\n    res.statusCode = httpCode;\n    return res.end(body);\n  },\n  sendInvalidURLResponse: function(res) {\n    return this.writeResponse(res, 404, \"url must has querys as instance_id.\");\n  },\n  sendAuthTokenExpiredResponse: function(res) {\n    return this.writeResponse(res, 401, \"the auth_token has expired.\");\n  },\n  replaceErrorSymbol: function(str) {\n    return str.replace(/\\\"/g, \"&quot;\").replace(/\\n/g, \"<br/>\");\n  },\n  getStepHandlerName: function(step, insId) {\n    var approverNames, e, loginUserId, stepHandlerName, stepId, userIds;\n    try {\n      stepHandlerName = \"\";\n      if (step.step_type === \"condition\") {\n        return stepHandlerName;\n      }\n      loginUserId = '';\n      stepId = step._id;\n      userIds = getHandlersManager.getHandlers(insId, stepId, loginUserId);\n      approverNames = userIds.map(function(userId) {\n        var user;\n        user = db.users.findOne(userId, {\n          fields: {\n            name: 1\n          }\n        });\n        if (user) {\n          return user.name;\n        } else {\n          return \"\";\n        }\n      });\n      stepHandlerName = approverNames.join(\",\");\n      return stepHandlerName;\n    } catch (error) {\n      e = error;\n      return \"\";\n    }\n  },\n  getStepLabel: function(stepName, stepHandlerName) {\n    if (stepName) {\n      stepName = \"<div class='graph-node'> <div class='step-name'>\" + stepName + \"</div> <div class='step-handler-name'>\" + stepHandlerName + \"</div> </div>\";\n      stepName = FlowversionAPI.replaceErrorSymbol(stepName);\n    } else {\n      stepName = \"\";\n    }\n    return stepName;\n  },\n  getStepName: function(step, cachedStepNames, instance_id) {\n    var cachedStepName, stepHandlerName, stepName;\n    cachedStepName = cachedStepNames[step._id];\n    if (cachedStepName) {\n      return cachedStepName;\n    }\n    stepHandlerName = FlowversionAPI.getStepHandlerName(step, instance_id);\n    stepName = FlowversionAPI.getStepLabel(step.name, stepHandlerName);\n    cachedStepNames[step._id] = stepName;\n    return stepName;\n  },\n  generateStepsGraphSyntax: function(steps, currentStepId, isConvertToString, direction, instance_id) {\n    var cachedStepNames, graphSyntax, nodes;\n    nodes = [\"graph \" + direction];\n    cachedStepNames = {};\n    steps.forEach(function(step) {\n      var lines;\n      lines = step.lines;\n      if (lines != null ? lines.length : void 0) {\n        return lines.forEach(function(line) {\n          var stepName, toStep, toStepName;\n          if (step.name) {\n            if (step.step_type === \"condition\") {\n              nodes.push(\"\tclass \" + step._id + \" condition;\");\n            }\n            stepName = FlowversionAPI.getStepName(step, cachedStepNames, instance_id);\n          } else {\n            stepName = \"\";\n          }\n          toStep = steps.findPropertyByPK(\"_id\", line.to_step);\n          toStepName = FlowversionAPI.getStepName(toStep, cachedStepNames, instance_id);\n          return nodes.push(\"\t\" + step._id + \"(\\\"\" + stepName + \"\\\")-->\" + line.to_step + \"(\\\"\" + toStepName + \"\\\")\");\n        });\n      }\n    });\n    if (currentStepId) {\n      nodes.push(\"\tclass \" + currentStepId + \" current-step-node;\");\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  getApproveJudgeText: function(judge) {\n    var judgeText, locale;\n    locale = \"zh-CN\";\n    switch (judge) {\n      case 'approved':\n        judgeText = TAPi18n.__('Instance State approved', {}, locale);\n        break;\n      case 'rejected':\n        judgeText = TAPi18n.__('Instance State rejected', {}, locale);\n        break;\n      case 'terminated':\n        judgeText = TAPi18n.__('Instance State terminated', {}, locale);\n        break;\n      case 'reassigned':\n        judgeText = TAPi18n.__('Instance State reassigned', {}, locale);\n        break;\n      case 'relocated':\n        judgeText = TAPi18n.__('Instance State relocated', {}, locale);\n        break;\n      case 'retrieved':\n        judgeText = TAPi18n.__('Instance State retrieved', {}, locale);\n        break;\n      case 'returned':\n        judgeText = TAPi18n.__('Instance State returned', {}, locale);\n        break;\n      case 'readed':\n        judgeText = TAPi18n.__('Instance State readed', {}, locale);\n        break;\n      default:\n        judgeText = '';\n        break;\n    }\n    return judgeText;\n  },\n  getTraceName: function(traceName, approveHandlerName) {\n    if (traceName) {\n      traceName = \"<div class='graph-node'> <div class='trace-name'>\" + traceName + \"</div> <div class='trace-handler-name'>\" + approveHandlerName + \"</div> </div>\";\n      traceName = FlowversionAPI.replaceErrorSymbol(traceName);\n    } else {\n      traceName = \"\";\n    }\n    return traceName;\n  },\n  getTraceFromApproveCountersWithType: function(trace) {\n    var approves, counters;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    approves.forEach(function(approve) {\n      if (approve.from_approve_id) {\n        if (!counters[approve.from_approve_id]) {\n          counters[approve.from_approve_id] = {};\n        }\n        if (counters[approve.from_approve_id][approve.type]) {\n          return counters[approve.from_approve_id][approve.type]++;\n        } else {\n          return counters[approve.from_approve_id][approve.type] = 1;\n        }\n      }\n    });\n    return counters;\n  },\n  getTraceCountersWithType: function(trace, traceFromApproveCounters) {\n    var approves, counters, isExpandApprove, traceMaxApproveCount;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    isExpandApprove = FlowversionAPI.isExpandApprove;\n    approves.forEach(function(toApprove) {\n      var toApproveFromId, toApproveHandlerName, toApproveType;\n      toApproveType = toApprove.type;\n      toApproveFromId = toApprove.from_approve_id;\n      toApproveHandlerName = toApprove.handler_name;\n      if (!toApproveFromId) {\n        return;\n      }\n      return approves.forEach(function(fromApprove) {\n        var counter, counter2, counterContent, ref;\n        if (fromApprove._id === toApproveFromId) {\n          counter = counters[toApproveFromId];\n          if (!counter) {\n            counter = counters[toApproveFromId] = {};\n          }\n          if (!counter[toApprove.type]) {\n            counter[toApprove.type] = [];\n          }\n          counter2 = counter[toApprove.type];\n          if ((ref = traceFromApproveCounters[toApprove._id]) != null ? ref[toApproveType] : void 0) {\n            return counter2.push({\n              from_type: fromApprove.type,\n              from_approve_handler_name: fromApprove.handler_name,\n              to_approve_id: toApprove._id,\n              to_approve_handler_name: toApprove.handler_name\n            });\n          } else {\n            counterContent = isExpandApprove ? null : counter2.findPropertyByPK(\"is_total\", true);\n            if (counterContent) {\n              counterContent.count++;\n              if (!(counterContent.count > traceMaxApproveCount)) {\n                return counterContent.to_approve_handler_names.push(toApprove.handler_name);\n              }\n            } else {\n              return counter2.push({\n                from_type: fromApprove.type,\n                from_approve_handler_name: fromApprove.handler_name,\n                to_approve_id: toApprove._id,\n                count: 1,\n                to_approve_handler_names: [toApprove.handler_name],\n                is_total: true\n              });\n            }\n          }\n        }\n      });\n    });\n    return counters;\n  },\n  pushApprovesWithTypeGraphSyntax: function(nodes, trace) {\n    var approves, currentTraceName, extraHandlerNamesCounter, fromApprove, fromApproveId, results, splitIndex, tempHandlerNames, toApproveId, toApproveType, toApproves, traceCounters, traceFromApproveCounters, traceMaxApproveCount;\n    traceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType(trace);\n    traceCounters = FlowversionAPI.getTraceCountersWithType(trace, traceFromApproveCounters);\n    if (!traceCounters) {\n      return;\n    }\n    extraHandlerNamesCounter = {};\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    splitIndex = FlowversionAPI.traceSplitApprovesIndex;\n    currentTraceName = trace.name;\n    for (fromApproveId in traceCounters) {\n      fromApprove = traceCounters[fromApproveId];\n      for (toApproveType in fromApprove) {\n        toApproves = fromApprove[toApproveType];\n        toApproves.forEach(function(toApprove) {\n          var extraCount, isTypeNode, strToHandlerNames, toHandlerNames, traceName, typeName;\n          typeName = \"\";\n          switch (toApproveType) {\n            case 'cc':\n              typeName = \"传阅\";\n              break;\n            case 'forward':\n              typeName = \"转发\";\n              break;\n            case 'distribute':\n              typeName = \"分发\";\n          }\n          isTypeNode = [\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.from_type) >= 0;\n          if (isTypeNode) {\n            traceName = toApprove.from_approve_handler_name;\n          } else {\n            traceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.from_approve_handler_name);\n          }\n          if (toApprove.is_total) {\n            toHandlerNames = toApprove.to_approve_handler_names;\n            if (splitIndex && toApprove.count > splitIndex) {\n              toHandlerNames.splice(splitIndex, 0, \"<br/>,\");\n            }\n            strToHandlerNames = toHandlerNames.join(\",\").replace(\",,\", \"\");\n            extraCount = toApprove.count - traceMaxApproveCount;\n            if (extraCount > 0) {\n              strToHandlerNames += \"等\" + toApprove.count + \"人\";\n              if (!extraHandlerNamesCounter[fromApproveId]) {\n                extraHandlerNamesCounter[fromApproveId] = {};\n              }\n              extraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id;\n            }\n          } else {\n            strToHandlerNames = toApprove.to_approve_handler_name;\n          }\n          if (isTypeNode) {\n            return nodes.push(\"\t\" + fromApproveId + \">\\\"\" + traceName + \"\\\"]--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          } else {\n            return nodes.push(\"\t\" + fromApproveId + \"(\\\"\" + traceName + \"\\\")--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          }\n        });\n      }\n    }\n    approves = trace.approves;\n    if (!_.isEmpty(extraHandlerNamesCounter)) {\n      results = [];\n      for (fromApproveId in extraHandlerNamesCounter) {\n        fromApprove = extraHandlerNamesCounter[fromApproveId];\n        results.push((function() {\n          var results1;\n          results1 = [];\n          for (toApproveType in fromApprove) {\n            toApproveId = fromApprove[toApproveType];\n            tempHandlerNames = [];\n            approves.forEach(function(approve) {\n              var ref;\n              if (fromApproveId === approve.from_approve_id) {\n                if (!((ref = traceFromApproveCounters[approve._id]) != null ? ref[toApproveType] : void 0)) {\n                  return tempHandlerNames.push(approve.handler_name);\n                }\n              }\n            });\n            results1.push(nodes.push(\"\tclick \" + toApproveId + \" callback \\\"\" + (tempHandlerNames.join(\",\")) + \"\\\"\"));\n          }\n          return results1;\n        })());\n      }\n      return results;\n    }\n  },\n  generateTracesGraphSyntax: function(traces, isConvertToString, direction) {\n    var graphSyntax, lastApproves, lastTrace, nodes;\n    nodes = [\"graph \" + direction];\n    lastTrace = null;\n    lastApproves = [];\n    traces.forEach(function(trace) {\n      var currentTraceName, lines;\n      lines = trace.previous_trace_ids;\n      currentTraceName = trace.name;\n      if (lines != null ? lines.length : void 0) {\n        lines.forEach(function(line) {\n          var currentFromTraceName, fromApproves, fromTrace, toApproves;\n          fromTrace = traces.findPropertyByPK(\"_id\", line);\n          currentFromTraceName = fromTrace.name;\n          fromApproves = fromTrace.approves;\n          toApproves = trace.approves;\n          lastTrace = trace;\n          lastApproves = toApproves;\n          return fromApproves.forEach(function(fromApprove) {\n            var fromApproveHandlerName, fromTraceName, judgeText, toTraceName;\n            fromApproveHandlerName = fromApprove.handler_name;\n            if (toApproves != null ? toApproves.length : void 0) {\n              return toApproves.forEach(function(toApprove) {\n                var fromTraceName, judgeText, toTraceName;\n                if ([\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.type) < 0) {\n                  if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                    fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                    toTraceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.handler_name);\n                    judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                    if (judgeText) {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    } else {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    }\n                  }\n                }\n              });\n            } else {\n              if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                toTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName);\n                judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                if (judgeText) {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                } else {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                }\n              }\n            }\n          });\n        });\n      } else {\n        trace.approves.forEach(function(approve) {\n          var traceName;\n          traceName = FlowversionAPI.getTraceName(currentTraceName, approve.handler_name);\n          return nodes.push(\"\t\" + approve._id + \"(\\\"\" + traceName + \"\\\")\");\n        });\n      }\n      return FlowversionAPI.pushApprovesWithTypeGraphSyntax(nodes, trace);\n    });\n    if (lastApproves != null) {\n      lastApproves.forEach(function(lastApprove) {\n        return nodes.push(\"\tclass \" + lastApprove._id + \" current-step-node;\");\n      });\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  sendHtmlResponse: function(req, res, type) {\n    var allowDirections, currentStepId, direction, error_msg, flowversion, graphSyntax, instance, instance_id, query, ref, ref1, steps, title, traces;\n    query = req.query;\n    instance_id = query.instance_id;\n    direction = query.direction || 'TD';\n    allowDirections = ['TB', 'BT', 'RL', 'LR', 'TD'];\n    if (!_.include(allowDirections, direction)) {\n      return this.writeResponse(res, 500, \"Invalid direction. The value of direction should be in ['TB', 'BT', 'RL', 'LR', 'TD']\");\n    }\n    if (!instance_id) {\n      FlowversionAPI.sendInvalidURLResponse(res);\n    }\n    title = query.title;\n    if (title) {\n      title = decodeURIComponent(decodeURIComponent(title));\n    } else {\n      title = \"Workflow Chart\";\n    }\n    error_msg = \"\";\n    graphSyntax = \"\";\n    FlowversionAPI.isExpandApprove = false;\n    if (type === \"traces_expand\") {\n      type = \"traces\";\n      FlowversionAPI.isExpandApprove = true;\n    }\n    switch (type) {\n      case 'traces':\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            traces: 1\n          }\n        });\n        if (instance) {\n          traces = instance.traces;\n          if (traces != null ? traces.length : void 0) {\n            graphSyntax = this.generateTracesGraphSyntax(traces, false, direction);\n          } else {\n            error_msg = \"没有找到当前申请单的流程步骤数据\";\n          }\n        } else {\n          error_msg = \"当前申请单不存在或已被删除\";\n        }\n        break;\n      default:\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            flow_version: 1,\n            flow: 1,\n            traces: {\n              $slice: -1\n            }\n          }\n        });\n        if (instance) {\n          currentStepId = (ref = instance.traces) != null ? (ref1 = ref[0]) != null ? ref1.step : void 0 : void 0;\n          flowversion = WorkflowManager.getInstanceFlowVersion(instance);\n          steps = flowversion != null ? flowversion.steps : void 0;\n          if (steps != null ? steps.length : void 0) {\n            graphSyntax = this.generateStepsGraphSyntax(steps, currentStepId, false, direction, instance_id);\n          } else {\n            error_msg = \"没有找到当前申请单的流程步骤数据\";\n          }\n        } else {\n          error_msg = \"当前申请单不存在或已被删除\";\n        }\n        break;\n    }\n    res.setHeader('Content-Type', 'text/html');\n    return this.writeResponse(res, 200, \"<!DOCTYPE html>\\n<html>\\n\t<head>\\n\t\t<meta charset=\\\"utf-8\\\">\\n\t\t<meta name=\\\"viewport\\\" content=\\\"width=device-width,initial-scale=1,user-scalable=yes\\\">\\n\t\t<title>\" + title + \"</title>\\n\t\t<meta name=\\\"mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"theme-color\\\" content=\\\"#000\\\">\\n\t\t<meta name=\\\"application-name\\\">\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"/unpkg.com/jquery@1.11.2/dist/jquery.min.js\\\"></script>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"/unpkg.com/mermaid@9.1.2/dist/mermaid.min.js\\\"></script>\\n\t\t<style>\\n\t\t\tbody { \\n\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tbackground-color: #fff;\\n\t\t\t}\\n\t\t\t.loading{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\ttop: 50%;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tmargin-top: -30px;\\n\t\t\t\tfont-size: 36px;\\n\t\t\t\tcolor: #dfdfdf;\\n\t\t\t}\\n\t\t\t.error-msg{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\tbottom: 20px;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tfont-size: 20px;\\n\t\t\t\tcolor: #a94442;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node rect{\\n\t\t\t\tfill: #ccccff;\\n\t\t\t\tstroke: rgb(144, 144, 255);\\n    \t\t\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.current-step-node rect{\\n\t\t\t\tfill: #cde498;\\n\t\t\t\tstroke: #13540c;\\n\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.condition rect{\\n\t\t\t\tfill: #ececff;\\n\t\t\t\tstroke: rgb(204, 204, 255);\\n    \t\t\t\t\t\tstroke-width: 1px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .trace-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .step-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\tdiv.mermaidTooltip{\\n\t\t\t\tposition: fixed!important;\\n\t\t\t\ttext-align: left!important;\\n\t\t\t\tpadding: 4px!important;\\n\t\t\t\tfont-size: 14px!important;\\n\t\t\t\tmax-width: 500px!important;\\n\t\t\t\tleft: auto!important;\\n\t\t\t\ttop: 15px!important;\\n\t\t\t\tright: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\\n\t\t\t\tborder-color: transparent;\\n\t\t\t\tdisplay: inline-block;\\n\t\t\t\tpadding: 2px 10px;\\n\t\t\t\tfont-size: 26px;\\n\t\t\t\tborder-radius: 20px;\\n\t\t\t\tbackground: #eee;\\n\t\t\t\tcolor: #777;\\n\t\t\t\tposition: fixed;\\n\t\t\t\tbottom: 15px;\\n\t\t\t\toutline: none;\\n\t\t\t\tcursor: pointer;\\n\t\t\t\tz-index: 99999;\\n\t\t\t\t-webkit-user-select: none;\\n\t\t\t\t-moz-user-select: none;\\n\t\t\t\t-ms-user-select: none;\\n\t\t\t\tuser-select: none;\\n\t\t\t\tline-height: 1.2;\\n\t\t\t}\\n\t\t\t@media (max-width: 768px) {\\n\t\t\t\t.btn-zoom{\\n\t\t\t\t\tdisplay:none;\\n\t\t\t\t}\\n\t\t\t}\\n\t\t\t.btn-zoom:hover{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\\n\t\t\t}\\n\t\t\t.btn-zoom-up{\\n\t\t\t\tleft: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom-down{\\n\t\t\t\tleft: 60px;\\n\t\t\t\tpadding: 1px 13px 3px 13px;\\n\t\t\t}\\n\t\t</style>\\n\t</head>\\n\t<body>\\n\t\t<div class = \\\"loading\\\">Loading...</div>\\n\t\t<div class = \\\"error-msg\\\">\" + error_msg + \"</div>\\n\t\t<div class=\\\"mermaid\\\"></div>\\n\t\t<script type=\\\"text/javascript\\\">\\n\t\t\tmermaid.initialize({\\n\t\t\t\tstartOnLoad:false\\n\t\t\t});\\n\t\t\t$(function(){\\n\t\t\t\tvar graphNodes = \" + (JSON.stringify(graphSyntax)) + \";\\n\t\t\t\t//方便前面可以通过调用mermaid.currentNodes调式，特意增加currentNodes属性。\\n\t\t\t\tmermaid.currentNodes = graphNodes;\\n\t\t\t\tvar graphSyntax = graphNodes.join(\\\"\\\\n\\\");\\n\t\t\t\tconsole.log(graphNodes);\\n\t\t\t\tconsole.log(graphSyntax);\\n\t\t\t\tconsole.log(\\\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\\\");\\n\t\t\t\t$(\\\".loading\\\").remove();\\n\\n\t\t\t\tvar id = \\\"flow-steps-svg\\\";\\n\t\t\t\tvar element = $('.mermaid');\\n\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\\n\t\t\t\t\telement.html(svgCode);\\n\t\t\t\t\tif(typeof callback !== 'undefined'){\\n\t\t\t\t\t\tcallback(id);\\n\t\t\t\t\t}\\n\t\t\t\t\tbindFunctions(element[0]);\\n\t\t\t\t};\\n\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\\n\\n\t\t\t\tvar zoomSVG = function(zoom){\\n\t\t\t\t\tvar currentWidth = $(\\\"svg\\\").width();\\n\t\t\t\t\tvar newWidth = currentWidth * zoom;\\n\t\t\t\t\t$(\\\"svg\\\").css(\\\"maxWidth\\\",newWidth + \\\"px\\\").width(newWidth);\\n\t\t\t\t}\\n\\n\t\t\t\t//支持鼠标滚轮缩放画布\\n\t\t\t\t$(window).on(\\\"mousewheel\\\",function(event){\\n\t\t\t\t\tif(event.ctrlKey){\\n\t\t\t\t\t\tevent.preventDefault();\\n\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\\n\t\t\t\t\t\tzoomSVG(zoom);\\n\t\t\t\t\t}\\n\t\t\t\t});\\n\t\t\t\t$(\\\".btn-zoom\\\").on(\\\"click\\\",function(){\\n\t\t\t\t\tzoomSVG($(this).attr(\\\"zoom\\\"));\\n\t\t\t\t});\\n\t\t\t});\\n\t\t</script>\\n\t\t<a class=\\\"btn-zoom btn-zoom-up\\\" zoom=1.1 title=\\\"点击放大\\\">+</a>\\n\t\t<a class=\\\"btn-zoom btn-zoom-down\\\" zoom=0.9 title=\\\"点击缩小\\\">-</a>\\n\t</body>\\n</html>\");\n  }\n};\n\nJsonRoutes.add('get', '/api/workflow/chart?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res);\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces\");\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces_expand\");\n});\n"]}